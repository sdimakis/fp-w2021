---
title: "Functional programming Midterm"
author: "Meg Siritzky, Lea Frank, Wanjia Guo, and Sarah Dimakis"
output: 
  html_document: 
    toc: yes
    toc_float: yes
    theme: yeti
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE)

library(tidyverse)
library(repurrrsive)
library(kableExtra)
library(rio)
library(glue)
library(dplyr)
```

# Part A (1) 

```{r}
download_file <- function(year) {
  link <- glue::glue("https://www.oregon.gov/ode/educator-resources/assessment/TestResults20{year}/pagr_schools_ela_raceethnicity_{year-1}{year}.xlsx")
  rio::import(link, setclass = "tibble", na = c("-", "--", "*"))
}

school_raw <- map_dfr(15:18, download_file)
```

```{r}
school_clean <- school_raw %>% 
  janitor::clean_names() %>% 
  filter(student_group == "White" |
           student_group == "Hispanic/Latino") %>% 
  pivot_longer(cols = c(number_level_1, number_level_2, number_level_3, number_level_4), names_to = "level", values_to = "n") %>% 
  mutate(level = recode(level, number_level_1 = "1"),
         level = recode(level, number_level_2 = "2"),
         level = recode(level, number_level_3 = "3"),
         level = recode(level, number_level_4 = "4")) %>% 
  dplyr::select(academic_year, district, school, student_group, grade_level, level, n) %>% 
  drop_na(n)
```

# Part A (2)

```{r}
school <- school_clean %>% 
  group_by(district) %>%
  mutate(n_schools = length(unique(school))) %>% 
  group_by(academic_year, district, level, student_group, n_schools) %>%
  summarize(n = sum(n)) %>% 
  pivot_wider(names_from = student_group, values_from = n) %>% 
  janitor::clean_names() %>% 
  drop_na(hispanic_latino, white) %>% 
  arrange(district) 

```

# Part B (1)

```{r}
#remotes::install_github("datalorax/gapr")
library(gapr)

school_map <- school %>% 
  group_by(district) %>% 
  nest() %>% 
  mutate(estv_map = map(data, ~estimate_v(data = .x, "white", "hispanic_latino")))

school_row <- school %>% 
  ungroup() %>% 
  nest_by(district) %>% 
  summarize(estv_row = list(estimate_v(data, "white", "hispanic_latino")))

school <- left_join(school_map, school_row)
```

# Part B (2)

```{r}
# not all models, unsure why
# filtered out those models to compare estimates
school <- school %>% 
  mutate(isnull_map = map_lgl(estv_map, ~ nrow(.x)==0),
         isnull_row = map_lgl(estv_row, ~ nrow(.x)==0)) %>% 
  filter(!isnull_map | !isnull_row) %>% 
  mutate(v_map = map_dbl(estv_map, "v"),
         v_row = map_dbl(estv_row, "v"))

school %>% 
  ggplot(aes(x = v_map, y = v_row)) + 
  geom_point(alpha = .5) +
  geom_line(color = "cadetblue") +
  labs(x = "Estimates from Purrr Method", 
       y = "Estimates from Rowwise Method") +
  theme_minimal()
```

